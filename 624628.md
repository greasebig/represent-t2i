# hidiffusion
å…³æ³¨comfyuiæ’ä»¶åŸç”Ÿå®ç°

sd.nextå·²ç»æ”¯æŒ    
4.29   
ä¼°è®¡æ˜¯ç›´æ¥ä½¿ç”¨diffusers    




ä¼˜å…ˆçº§åº”è¯¥æ˜¯hidiffusion ç„¶åcfg++     
æˆ–è€…cfgè®¾æ³•hookè¿‡å» å·²æœ‰ä¸€äº›ä»£ç      
ä½†æˆ‘æ„Ÿè§‰æ•ˆæœæ²¡é‚£ä¹ˆå¥½       

æ–‡ç”Ÿå›¾åŠŸèƒ½ sdxlä¼˜å…ˆæ”¯æŒ

Update

2024.6.19 - ğŸ’¥ Integrated into OpenBayes, see the demo. Thank OpenBayes team!

2024.6.16 - ğŸ’¥ Support PyTorch 2.X.

2024.6.16 - ğŸ’¥ Fix non-square generation issue. Now HiDiffusion supports more image sizes and aspect ratios.

2024.5.7 - ğŸ’¥ Support image-to-image task, see here.

2024.4.16 - ğŸ’¥ Release source code.


å¦‚ä½•åœ¨ Automatic1111 Stable Diffusion Web UI ä¸­ä½¿ç”¨å®ƒï¼ˆé€‚ç”¨äº SD 1.5ã€XL ç­‰ï¼‰ #8    
è¿™ä¸ªè®¨è®ºå¤ªæ—© 5.11æœ€æ™š      

ComfyUI æ”¯æŒå—ï¼Ÿ #1     
è¿™ä¸ªä¹Ÿå¾ˆæ—© 5.22æœ€æ™š

https://github.com/blepping/comfyui_jankhidiffusion#use-with-controlnet     
è¿™ä¸ªåŸç”Ÿæ’ä»¶æ›´æ–°äº 5.21æœ€æ™š éš¾ä»¥é€‚ç”¨     


https://github.com/florestefano1975/ComfyUI-HiDiffusion    
è¿™ä¸ªdiffusersåŒ…è£…æ’ä»¶zuiwangengä¿¡èª‰5.4 ä¹Ÿå¤ªæ—©




Supported Tasks
âœ… Text-to-image
âœ… ControlNet, including text-to-image, image-to-image
âœ… Inpainting

Supported Models
âœ… Stable Diffusion XL
âœ… Stable Diffusion XL Turbo
âœ… Stable Diffusion v2
âœ… Stable Diffusion v1
Note: HiDiffusion also supports the downstream diffusion models based on these repositories, such as Ghibli-Diffusion, Playground, etc.

é«˜åˆ†è¾¨ç±»ä¼¼      
Kohya Deep Shrink     
ScaleCrafter    

https://arxiv.org/abs/2311.17528

[Submitted on 29 Nov 2023 (v1), last revised 29 Apr 2024 (this version, v2)]

HiDiffusion: Unlocking Higher-Resolution Creativity and Efficiency in Pretrained Diffusion Models

æ‰©æ•£æ¨¡å‹å·²æˆä¸ºé«˜åˆ†è¾¨ç‡å›¾åƒåˆæˆçš„ä¸»æµæ–¹æ³•ã€‚ç„¶è€Œï¼Œç›´æ¥ä»é¢„è®­ç»ƒçš„æ‰©æ•£æ¨¡å‹ç”Ÿæˆæ›´é«˜åˆ†è¾¨ç‡çš„å›¾åƒä¼šé‡åˆ°ä¸åˆç†çš„å¯¹è±¡é‡å¤å¹¶æˆå€å¢åŠ ç”Ÿæˆæ—¶é—´ã€‚åœ¨æœ¬æ–‡ä¸­ï¼Œæˆ‘ä»¬å‘ç°å¯¹è±¡é‡å¤æºäº U-Net æ·±å±‚å—ä¸­çš„ç‰¹å¾é‡å¤ã€‚åŒæ—¶ï¼Œæˆ‘ä»¬å°†ç”Ÿæˆæ—¶é—´çš„å»¶é•¿å½’å› äº U-Net é¡¶éƒ¨å—ä¸­çš„è‡ªæ³¨æ„åŠ›å†—ä½™ã€‚ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜ï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ä¸ªæ— éœ€è°ƒæ•´çš„é«˜åˆ†è¾¨ç‡æ¡†æ¶ HiDiffusionã€‚å…·ä½“æ¥è¯´ï¼ŒHiDiffusion åŒ…å«åˆ†è¾¨ç‡æ„ŸçŸ¥ U-Net (RAU-Net)ï¼Œå®ƒå¯ä»¥åŠ¨æ€è°ƒæ•´ç‰¹å¾å›¾å¤§å°æ¥è§£å†³å¯¹è±¡é‡å¤é—®é¢˜ï¼Œå¹¶ä½¿ç”¨æ”¹è¿›çš„ç§»ä½çª—å£å¤šå¤´è‡ªæ³¨æ„åŠ› (MSW-MSA)ï¼Œåˆ©ç”¨ä¼˜åŒ–çš„çª—å£æ³¨æ„åŠ›æ¥å‡å°‘è®¡ç®—ã€‚æˆ‘ä»¬å¯ä»¥å°† HiDiffusion é›†æˆåˆ°å„ç§é¢„è®­ç»ƒçš„æ‰©æ•£æ¨¡å‹ä¸­ï¼Œä»¥å°†å›¾åƒç”Ÿæˆåˆ†è¾¨ç‡æ‰©å±•åˆ° 4096x4096ï¼Œæ¨ç†é€Ÿåº¦æ˜¯ä»¥å‰æ–¹æ³•çš„ 1.5-6 å€ã€‚å¤§é‡å®éªŒè¡¨æ˜ï¼Œæˆ‘ä»¬çš„æ–¹æ³•å¯ä»¥è§£å†³å¯¹è±¡é‡å¤å’Œè®¡ç®—é‡å¤§çš„é—®é¢˜ï¼Œåœ¨é«˜åˆ†è¾¨ç‡å›¾åƒåˆæˆä»»åŠ¡ä¸Šå®ç°æœ€å…ˆè¿›çš„æ€§èƒ½ã€‚


![alt text](assets/624628/image.png)
















# cfg++

https://github.com/invoke-ai/InvokeAI/issues/6516    
ä¸¤å‘¨å‰åˆ°å››å¤©å‰

https://github.com/invoke-ai/InvokeAI/pull/4335     
Nov 30, 2023    
cfg rescale å·²ç»merge


https://github.com/dunkeroni/InvokeAI_ModularDenoiseNodes


https://gitlab.com/keturn/invert_denoise_invoke/-/tree/invoke-v3.5






CFG++ ä¸ CFG Rescale ä¸€æ ·ï¼Œè¯•å›¾è§£å†³çº¿æ€§æ— åˆ†ç±»å™¨å¼•å¯¼å‡½æ•°å®¹æ˜“äº§ç”Ÿåˆ†å¸ƒå¤–å€¼çš„æ–¹å¼ã€‚

CFG++, like CFG Rescale, is an attempt to address the way the linear Classifier-Free Guidance function is prone to producing out-of-distribution values.


æ®æˆ‘äº†è§£ï¼Œæ•°å­¦å¾ˆç®€å•ã€‚ä½†å®ƒä»¥ä¸€ç§å¯æ€•çš„æ–¹å¼ä¸è°ƒåº¦å™¨åœ¨æ‰©æ•£å™¨ä¸­çš„æŠ½è±¡æ–¹å¼ï¼ˆä»¥åŠ Invokeï¼‰å‘ç”Ÿå†²çªã€‚æˆ‘å·²ç»åˆ›å»ºäº†è¿™ä¸ªé—®é¢˜ï¼Œæ‰€ä»¥æœ‰ä¸€ä¸ªåœ°æ–¹å¯ä»¥è®°å½•å®ƒã€‚

But it clashes in an awful way with how Schedulers are abstracted in diffusers (and thus Invoke). I've created this issue so there's a place to keep notes about that.


Invoke åŸºäº diffusersæ„å»ºï¼Ÿ?


æ— åˆ†ç±»å™¨å¼•å¯¼ (CFG)æ˜¯ç°ä»£æ‰©æ•£æ¨¡å‹ä¸­ç”¨äºæ–‡æœ¬å¼•å¯¼ç”Ÿæˆçš„åŸºæœ¬å·¥å…·ã€‚å°½ç®¡ CFG å¾ˆæœ‰æ•ˆï¼Œä½†å®ƒéœ€è¦è¾ƒé«˜çš„å¼•å¯¼è§„æ¨¡ï¼Œè¿™æœ‰æ˜æ˜¾çš„ç¼ºç‚¹ï¼š

æ¨¡å¼å´©æºƒå’Œé¥±å’Œ
å¯é€†æ€§è¾ƒå·®
ä¸è‡ªç„¶ã€å¼¯æ›²çš„ PF-ODE è½¨è¿¹



æˆ‘ä»¬é’ˆå¯¹è¿™ä¸ªçœ‹ä¼¼å›ºæœ‰çš„é™åˆ¶æå‡ºäº†ä¸€ä¸ªç®€å•çš„è§£å†³æ–¹æ¡ˆï¼Œå¹¶æå‡ºäº† CFG++ï¼Œå®ƒçº æ­£äº† CFG çš„æµå½¢å¤–é—®é¢˜ã€‚è§‚å¯Ÿåˆ°ä»¥ä¸‹ä¼˜ç‚¹

![alt text](assets/624628/image-1.png)

æ ·æœ¬è´¨é‡æ›´å¥½ï¼Œæ›´ç¬¦åˆåŸæ–‡è¦æ±‚
æ›´å¹³æ»‘ã€æ›´ç›´çš„ PF-ODE è½¨è¿¹
å¢å¼ºå¯é€†æ€§

å®éªŒç»“æœè¯å®ï¼Œæˆ‘ä»¬çš„æ–¹æ³•æ˜¾è‘—æé«˜äº†æ–‡æœ¬åˆ°å›¾åƒç”Ÿæˆã€DDIM åè½¬ã€ç¼–è¾‘å’Œè§£å†³é€†é—®é¢˜çš„æ€§èƒ½ï¼Œè¡¨æ˜åœ¨åˆ©ç”¨æ–‡æœ¬æŒ‡å¯¼çš„å„ä¸ªé¢†åŸŸå…·æœ‰å¹¿æ³›çš„å½±å“å’Œæ½œåœ¨çš„åº”ç”¨ã€‚


> [!note]
> This work is currently in the preprint stage, and there may be some changes to the code.


è¿™åº”è¯¥æ˜¯ä¸€ä¸ªå¤±è´¥é¡¹ç›®

CFG++: Manifold-constrained Classifier Free Guidance For Diffusion Models
Hyungjin Chung*, Jeongsol Kim*, Geon Yeong Park*, Hyelin Nam*, Jong Chul Ye
KAIST


![alt text](assets/624628/image-2.png)



å®˜æ–¹ä»…æœ‰ddimæ”¯æŒ

image edit è®ºæ–‡ä¸Šçœ‹èµ·æ¥æ•ˆæœæ¯”è¾ƒå¥½

æ–‡ç”Ÿå›¾æ¯”è¾ƒä¸ç¨³å®š

editå¦‚ä½•ç”¨ï¼Ÿ









# ç»“å°¾