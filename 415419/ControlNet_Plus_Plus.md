Inference code for: ControlNet++: Improving Conditional Controls with Efficient Consistency Feedback     
ControlNet++ï¼šé€šè¿‡é«˜æ•ˆçš„ä¸€è‡´æ€§åé¦ˆæ”¹è¿›æ¡ä»¶æ§åˆ¶    
https://github.com/liming-ai/ControlNet_Plus_Plus   

è¿™æ˜¯ä¸ªå¿«é€Ÿç‰ˆcontrolnet ä½¿ç”¨lcmåŠ é€Ÿcontrolnet

æœ‰ç‚¹ç±»ä¼¼ST-GCN++å‘½å 


# è®ºæ–‡ä¿¡æ¯
[Submitted on 11 Apr 2024]     
ControlNet++: Improving Conditional Controls with Efficient Consistency Feedback    
https://arxiv.org/abs/2404.07987  

Center for Research in Computer Vision, University of Central Florida      
2 ByteDance Inc     
å‡ ä¸ªç¾å›½ä½›ç½—é‡Œè¾¾å¤§å­¦ç•™å­¦ç”Ÿåœ¨å­—èŠ‚å®ä¹     

æˆ‘ä»¬æ­ç¤ºäº†ç°æœ‰æ–¹æ³•åœ¨ç”Ÿæˆä¸å›¾åƒæ¡ä»¶æ§åˆ¶ä¸€è‡´çš„å›¾åƒæ–¹é¢ä»ç„¶é¢ä¸´é‡å¤§æŒ‘æˆ˜ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬æå‡ºäº† ControlNet++ï¼Œè¿™æ˜¯ä¸€ç§æ–°é¢–çš„æ–¹æ³•ï¼Œé€šè¿‡æ˜¾å¼ä¼˜åŒ–ç”Ÿæˆå›¾åƒå’Œæ¡ä»¶æ§åˆ¶ä¹‹é—´çš„åƒç´ çº§å¾ªç¯ä¸€è‡´æ€§æ¥æ”¹è¿›å¯æ§ç”Ÿæˆã€‚å…·ä½“æ¥è¯´ï¼Œå¯¹äºè¾“å…¥æ¡ä»¶æ§åˆ¶ï¼Œæˆ‘ä»¬ä½¿ç”¨é¢„è®­ç»ƒçš„åˆ¤åˆ«å¥–åŠ±æ¨¡å‹æ¥æå–ç”Ÿæˆå›¾åƒçš„ç›¸åº”æ¡ä»¶ï¼Œç„¶åä¼˜åŒ–è¾“å…¥æ¡ä»¶æ§åˆ¶å’Œæå–æ¡ä»¶ä¹‹é—´çš„ä¸€è‡´æ€§æŸå¤±ã€‚ä¸€ç§ç®€å•çš„å®ç°æ˜¯ä»éšæœºå™ªå£°ç”Ÿæˆå›¾åƒï¼Œç„¶åè®¡ç®—ä¸€è‡´æ€§æŸå¤±ï¼Œä½†è¿™ç§æ–¹æ³•éœ€è¦å­˜å‚¨å¤šä¸ªé‡‡æ ·æ—¶é—´æ­¥é•¿çš„æ¢¯åº¦ï¼Œä»è€Œå¯¼è‡´ç›¸å½“å¤šçš„æ—¶é—´å’Œå†…å­˜æˆæœ¬ã€‚ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬å¼•å…¥äº†ä¸€ç§æœ‰æ•ˆçš„å¥–åŠ±ç­–ç•¥ï¼Œé€šè¿‡æ·»åŠ å™ªå£°æ•…æ„å¹²æ‰°è¾“å…¥å›¾åƒï¼Œç„¶åä½¿ç”¨å•æ­¥å»å™ªå›¾åƒè¿›è¡Œå¥–åŠ±å¾®è°ƒã€‚è¿™é¿å…äº†ä¸å›¾åƒé‡‡æ ·ç›¸å…³çš„å¤§é‡æˆæœ¬ï¼Œä»è€Œå¯ä»¥æ›´æœ‰æ•ˆåœ°è¿›è¡Œå¥–åŠ±å¾®è°ƒã€‚å¤§é‡å®éªŒè¡¨æ˜ControlNet++æ˜¾ç€æé«˜äº†å„ç§æ¡ä»¶æ§åˆ¶ä¸‹çš„å¯æ§æ€§ã€‚ä¾‹å¦‚ï¼Œåœ¨åˆ†å‰²æ©æ¨¡ã€è‰ºæœ¯çº¿æ¡è¾¹ç¼˜å’Œæ·±åº¦æ¡ä»¶æ–¹é¢ï¼Œå®ƒæ¯” ControlNet åˆ†åˆ«æé«˜äº† 7.9% mIoUã€13.4% SSIM å’Œ 7.6% RMSEã€‚       

![alt text](assets/ControlNet_Plus_Plus/image.png)     


# demo
The first row in outputs is the input conditions. The second row is the images generated by ControlNet++. The third row is the conditions extracted from our generated images. Please note that we use the SD1.5 and trained on specific public datasets, so the quality of the generated images may not be as good as models such as SDXL-based models, or trained on private datasets. For example, the image quality and resolution in the ADE20K dataset (Segmentation) are often poor     
![alt text](assets/ControlNet_Plus_Plus/image-1.png)   
![alt text](assets/ControlNet_Plus_Plus/image-2.png)    
![alt text](assets/ControlNet_Plus_Plus/image-3.png)     
![alt text](assets/ControlNet_Plus_Plus/image-4.png)    

![alt text](assets/ControlNet_Plus_Plus/image-5.png)    
![alt text](assets/ControlNet_Plus_Plus/image-6.png)   

![alt text](<assets/ControlNet_Plus_Plus/æˆªå±2024-04-28 15.04.32.png>)    






We noticed the results in the online demo are unstable: The same code, weights and random seeds have huge differences in results under different spaces, which may due to the ZeroGPU. If it is convenient, please git clone and run it locally.


![alt text](assets/ControlNet_Plus_Plus/image-7.png)   




# æ¨¡å‹ä¿¡æ¯
åŸºäºsd1.5


# åŸç†
ControlNet++: Improving Conditional Controls with Efficient Consistency Feedback     

Cycle Consistency for Conditional Generation    
![alt text](assets/ControlNet_Plus_Plus/image-8.png)   
we can directly optimize the cycle consistency loss for better controllability.    

Directly Optimization for Controllability:     
![alt text](assets/ControlNet_Plus_Plus/image-9.png)   
utilize discriminative reward modelsÂ ğ·Â to explicitly optimize the controllability ofÂ ğºÂ via pixel-level cycle consistency loss.    

Efficient Reward Strategy:     
![alt text](assets/ControlNet_Plus_Plus/image-10.png)    
(a) Pipeline of default reward fine-tuning strategy. Reward fine-tuning requires sampling all the way to the full image. Such a method needs to keep all gradients for each timestep and the memory required is unbearable by current GPUs. (b) We add a small noise (
) to disturb the consistency between input images and conditions, then the single-step denoised image can be directly used for efficient reward fine-tuning.ï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿï¼Ÿ


![alt text](assets/ControlNet_Plus_Plus/image-11.png)????      

ä¸ºäº†å®ç°åƒç´ ç©ºé—´ä¸€è‡´æ€§æŸå¤± Lrewardï¼Œéœ€è¦æœ€ç»ˆçš„æ‰©æ•£å›¾åƒ x0 æ¥è®¡ç®—å¥–åŠ±æ¨¡å‹çš„å¥–åŠ±ä¸€è‡´æ€§ã€‚ ç”±äºç°ä»£æ‰©æ•£æ¨¡å‹ï¼Œä¾‹å¦‚ç¨³å®šæ‰©æ•£[43]ï¼Œéœ€è¦å¤šä¸ªæ­¥éª¤ï¼Œä¾‹å¦‚ 50 ä¸ªæ­¥éª¤æ¥æ¸²æŸ“å®Œæ•´å›¾åƒï¼Œç›´æ¥ä½¿ç”¨è¿™æ ·çš„è§£å†³æ–¹æ¡ˆåœ¨ç°å®è®¾ç½®ä¸­æ˜¯ä¸åˆ‡å®é™…çš„ï¼šï¼ˆ1ï¼‰éœ€è¦å¤šæ¬¡è€—æ—¶çš„é‡‡æ · ä»éšæœºå™ªå£°ä¸­è·å–å›¾åƒã€‚  (2) ä¸ºäº†å¯ç”¨æ¢¯åº¦åå‘ä¼ æ’­ï¼Œæˆ‘ä»¬å¿…é¡»åœ¨æ¯ä¸ªæ—¶é—´æ­¥å­˜å‚¨æ¢¯åº¦ï¼Œè¿™æ„å‘³ç€ GPU å†…å­˜ä½¿ç”¨é‡å°†éšç€æ—¶é—´æ­¥çš„æ•°é‡çº¿æ€§å¢åŠ ã€‚ ä»¥ControlNetä¸ºä¾‹ï¼Œå½“æ‰¹é‡å¤§å°ä¸º1ä¸”FP16æ··åˆç²¾åº¦æ—¶ï¼Œå•ä¸ªå»å™ªæ­¥éª¤å’Œå­˜å‚¨æ‰€æœ‰è®­ç»ƒæ¢¯åº¦æ‰€éœ€çš„GPUå†…å­˜çº¦ä¸º6.8GBã€‚ å¦‚æœæˆ‘ä»¬ä½¿ç”¨ DDIM [51] è°ƒåº¦å™¨è¿›è¡Œ 50 æ­¥æ¨ç†ï¼Œåˆ™éœ€è¦å¤§çº¦ 340GB çš„å†…å­˜æ¥å¯¹å•ä¸ªæ ·æœ¬è¿›è¡Œå¥–åŠ±å¾®è°ƒï¼Œè¿™åœ¨å½“å‰çš„ç¡¬ä»¶èƒ½åŠ›ä¸‹å‡ ä¹ä¸å¯èƒ½å®ç°ã€‚

å°½ç®¡å¯ä»¥é€šè¿‡é‡‡ç”¨ä½ç§©é€‚åº”ï¼ˆLoRAï¼‰[11, 20]ã€æ¢¯åº¦æ£€æŸ¥ç‚¹[7, 11]æˆ–åœæ­¢æ¢¯åº¦[60]ç­‰æŠ€æœ¯æ¥å‡å°‘GPUå†…å­˜æ¶ˆè€—ï¼Œä½†é‡‡æ ·æ¬¡æ•°å¯¼è‡´çš„æ•ˆç‡ä¸‹é™ ç”Ÿæˆå›¾åƒæ‰€éœ€çš„æ­¥éª¤ä»ç„¶å¾ˆé‡è¦ä¸”ä¸å®¹å¿½è§†ã€‚ å› æ­¤ï¼Œéœ€è¦ä¸€ç§æœ‰æ•ˆçš„å¥–åŠ±å¾®è°ƒæ–¹æ³•ã€‚

è¿™ä¸ªæœ¬è´¨ä¸Šè¿˜æ˜¯å‡å°‘äº†é‡‡æ ·æ­¥éª¤ï¼Œæ¢é€Ÿåº¦     
è®¾ç½®äº†ä¸€ä¸ªt_thre

![alt text](assets/ControlNet_Plus_Plus/image-13.png)

![alt text](assets/ControlNet_Plus_Plus/image-12.png)

å…¶ä¸­ tthre è¡¨ç¤ºæ—¶é—´æ­¥é•¿é˜ˆå€¼ï¼Œå®ƒæ˜¯ä¸€ä¸ªè¶…å‚æ•°ï¼Œç”¨äºç¡®å®šæ˜¯å¦åº”åˆ©ç”¨å™ªå£°å›¾åƒ xt è¿›è¡Œå¥–åŠ±å¾®è°ƒã€‚ æˆ‘ä»¬æ³¨æ„åˆ°ï¼Œå°çš„å™ªå£° Îµï¼ˆå³ç›¸å¯¹è¾ƒå°çš„æ—¶é—´æ­¥é•¿ tï¼‰ä¼šæ‰°ä¹±ä¸€è‡´æ€§å¹¶å¯¼è‡´æœ‰æ•ˆçš„å¥–åŠ±å¾®è°ƒã€‚ å½“æ—¶é—´æ­¥é•¿ t è¾ƒå¤§æ—¶ï¼Œxt æ›´æ¥è¿‘éšæœºå™ªå£° xT ï¼Œç›´æ¥ä» xt é¢„æµ‹ xâ€²0 ä¼šå¯¼è‡´ä¸¥é‡çš„å›¾åƒå¤±çœŸã€‚ æˆ‘ä»¬é«˜æ•ˆå¥–åŠ±çš„ä¼˜ç‚¹æ˜¯ï¼Œxt å¯ä»¥ç”¨æ¥è®­ç»ƒå’Œå¥–åŠ±æ‰©æ•£æ¨¡å‹ï¼Œè€Œä¸éœ€è¦å¤šæ¬¡é‡‡æ ·å¸¦æ¥çš„æ—¶é—´å’Œ GPU å†…å­˜æˆæœ¬ï¼Œä»è€Œæ˜¾ç€æé«˜å¥–åŠ±å¾®è°ƒé˜¶æ®µçš„æ•ˆç‡ã€‚

å¯¹ä»–ä»¬æå‡ºçš„è¿™ç§åƒç´ ç©ºé—´æŸå¤±æ–¹æ³•çš„æ„šè ¢è¡¥å……å’Œæ”¹æ­£    




ä¸ä»éšæœºå™ªå£° xT æ‰©æ•£ä»¥è·å¾—æœ€ç»ˆå›¾åƒ x0 ç›¸æ¯”ï¼Œå¦‚å›¾ 4ï¼ˆaï¼‰æ‰€ç¤ºï¼Œæˆ‘ä»¬æå‡ºäº†ä¸€ç§ä¸€æ­¥å¼æœ‰æ•ˆå¥–åŠ±ç­–ç•¥ã€‚ å…·ä½“æ¥è¯´ï¼Œæˆ‘ä»¬ä¸æ˜¯ä»å™ªå£°ä¸­éšæœºé‡‡æ ·ï¼Œè€Œæ˜¯å‘è®­ç»ƒå›¾åƒ x0 æ·»åŠ å™ªå£°ï¼Œä»è€Œé€šè¿‡æ‰§è¡Œç­‰å¼ä¸­çš„æ‰©æ•£å‰å‘è¿‡ç¨‹ q(xt|x0) æ¥æ˜ç¡®æ‰°ä¹±æ‰©æ•£è¾“å…¥ xâ€²t ä¸å…¶æ¡ä»¶æ§åˆ¶ cv ä¹‹é—´çš„ä¸€è‡´æ€§ã€‚  1. æˆ‘ä»¬å°†æ­¤è¿‡ç¨‹æ¼”ç¤ºä¸ºå›¾ 4 (b) ä¸­çš„å¹²æ‰°ä¸€è‡´æ€§ï¼Œè¿™ä¸æ ‡å‡†æ‰©æ•£è®­ç»ƒè¿‡ç¨‹ç›¸åŒã€‚ å½“æ·»åŠ çš„å™ªå£°Îµè¾ƒå°æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹å—å¹²æ‰°å›¾åƒxâ€²tè¿›è¡Œå•æ­¥é‡‡æ ·3æ¥é¢„æµ‹åŸå§‹å›¾åƒxâ€²0[18      
![alt text](assets/ControlNet_Plus_Plus/image-15.png)   
æ ¸å¿ƒæé«˜ä»–ä»¬æ–¹æ³•æ•ˆç‡çš„å…¬å¼     
ä»å°‘æ­¥æ¨ç†å€Ÿé‰´    
wired    

åˆå’Œä¸€è‡´æ€§ç›¸å…³    
é‚£ä¹ˆå…¶å®èµ·æºäºlcm   
è€Œä¸”åªæ˜¯åœ¨è®­ç»ƒæ—¶ä¼˜åŒ–ï¼Œæ¨ç†æ²¡æœ‰    


## lcm
[Submitted on 6 Oct 2023]   
Latent Consistency Models: Synthesizing High-Resolution Images with Few-Step Inference     

Institute for Interdisciplinary Information Sciences, Tsinghua University     

å…¬å¼å¤ªå¤šäº†æ²¡æ—¶é—´ç†






# ç»“å°¾

